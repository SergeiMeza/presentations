slidenumbers: true
autoscale: true

<!-- Header -->

# ランタイムデバッグのススメ

## iOSDC2021 TrackA Day2

### noppe / iOS app developer

^ おはようございます、iOSDC最終日の朝ということで皆さんお疲れさまです。
^ このセッションではランタイムデバッグのススメというタイトルで、開発テクニックに関する話をしていきます。

---

# noppe

![right](profile.png)

- 株式会社ディー・エヌ・エー
  - ソーシャルライブPococha
- iOSDC 4年目
- 個人アプリ開発
  - バーチャル自撮りアプリvear

^ まずは軽く自己紹介をさせてください。
^ キツネのアイコンで活動しているnoppeと言います。
^ 株式会社ディー・エヌ・エーでPocochaというアプリのiOSアプリエンジニアをしています。
^ iOSDCはありがたいことに4年連続で採択して頂いていて、毎年Pocochaに関わる少しコアな話をしているのですが、今回は比較的ライトなセッションになります。
^ お気軽に聞いていただければと思います。
^ また、個人でバーチャルアバターの自撮りアプリのvearを開発しています。
^ 今日話す開発テクニックは、Pocochaとvearの両方で採用しているものなので小さなアプリから大きなアプリまで参考になると思います。

---

![fit](cfp.png)

^ さて、早速ですがタイトルにもなっているランタイムデバッグという言葉なのですが

---

![fit](NotFound.png)

^ 存在しない言葉でした。すいません。

---

[.slidenumber: false]

![fit](NotFound.png)

存在しない単語なので…

# 定義

実行中のアプリで、デバッグをすること[^1]

≒ 実機テスト

とします。

[^1]:このセッションの中での定義

^ なので言葉の定義が必要なのですが、このセッションの中では「実行中のアプリでデバッグをする事」とさせてください。
^ 例えば、Testflightのベータ版アプリをプレイすることも、この定義に含まれます。
^ ここから分かるように、ランタイムデバッグとは皆さんが普段開発の中で行っている、一般的なデバッグ操作の事を指しています。

---

[.code-highlight: all]
[.code-highlight: 3]
[.code-highlight: 6-10]

## 開発フロー

```
1. コーディング・仕様策定・etc
2. コンパイル
3. シミュレータ・デバイス実行・ライブプレビュー
4. UnitTest
5. 結合テスト
6. CI
7. QA
8. ベータテスト
9. リリーステスト
10. 本番テスト
```

^ ランタイムデバッグは、アプリ開発の中の多くのステップで実施されています。
^ 例えば、アプリの開発フローの中で、最初にランタイムデバッグを行うのはコンパイル直後の3番のステップです。
^ このステップでは、アプリのレイアウトやアニメーションといったUnitテストでテストし難い部分をプレビューしながら開発を進めます。
^ 最近ではSwiftUIのプレビューがXcodeで行えるようになった為、1~3のイテレーションはかなり高速になりました。
^ iOSアプリはリッチなGUIを持つため、レイアウトやアニメーションといった機能は直接実行結果を参照することがほとんどかと思います。
^ また、7以降では、アプリはエンジニアの手を離れてadhocやTestFlightといった手段でチームメンバーや外部テスターに届けられます。

---

# ランタイムデバッグの特徴

- 人間が手作業で行う
- エンジニアが行うとは限らない
- 開発ステップの多くで実施される

^ このようにランタイムデバッグの多くは人の手で行われ、そして時間をかけて行われます。
^ UnitTestで検証し難い箇所を確認出来る反面、人の手が関わるとトレードオフになるものも存在します。

---

[.build-lists: true]

# ランタイムデバッグのトレードオフ

- 時間 ≒ コスト・事業的リスク
- 精度
- 関心

^ トレードオフになる１つ目は時間です。
^ これは言うまでもないですが、人間の操作は非常に時間がかかります。
^ それによって、金銭的なコストもかかりますし、競合のリリースサイクルに負ける事業的なリスクもあります。
^ 本当に必要な部分だけを人間の手で検証するべきではあるのですが、それが出来るのはそもそもこの時間的コストや金銭的コストに余裕のある開発が出来るところかと思います。現実的にはかなり理想論に近いと思います。
^ ２つ目は精度です。これは人間がミスする生き物だからですね。
^ ３つ目が、関心です。これは表現が難しいのですが、ランタイムデバッグをするということはTODO
^ 今日はこれら３つのトレードオフを

---

## 検証のステップ

1. コンパイル
2. 転送
3. 環境の確認
4. 環境の設定
5. 画面までの操作
6. 動作検証

^ 検証速度を上げるには、ランタイムデバッグにおいてどのような行動をしているかを把握する
^ これらの時間を短くすることで検証速度を上げることができる。
^ 他のセッションでも話されているので、ここではランタイムデバッグを上手に使った改善をしてみます。
^ そもそもSwiftUIというのがある

---

### デバッグメニュー

ゲームなどで実装されることの多い機能

^ ランタイムデバッグを快適にしていく上で欠かせないのが、デバッグメニューです
^ デバッグメニューは、その名の通りデバッグに利用する機能を呼び出すためのメニューを指します。
^ デバッグメニューは、ゲームなどでよく見かける機能ですが、アプリの開発でも恩恵を受けることが出来ます。
^ アプリの設定画面にメニュー用のViewControllerを追加するだけで良い
^ 自分で弄れるエンジニア以外にとっては、神モードといっても差し支えない

---

### デバッグメニュー

```swift
func onTapSettings(section: Section) {
    switch section {
        case .general:
            ...
        case .debugMenu:
            #if DEBUG
            let vc = DebugMenuViewController()
            present(vc, animated: true)
            #endif
    }
}
```

![original](code_background.png)

^ #if DEBUGで囲うことで

---

## 検証速度の改善

### 環境の確認

- バージョン番号、ビルド番号
- OSのバージョン、モデル
- 回線速度

### アプリの中で見れるようにする

- デバッグメニューの基本
- アプリから手を離さずに欲しい情報が取れるようにする

^ 検証を行う上で、現在動作している環境が想定しているものかどうかを確かめる必要があります。
^ この確認作業は意外と時間がかかるもの。例えばOSバージョン一つ見るのに設定アプリから2タップが必要
^ アプリの中で見れるようにすると良いです。
^ fast.comとかで測るといいよ

---

## 検証速度の改善

###　環境の設定

- 接続先サーバーの決定
- ユーザーのログイン
- キャッシュのクリア

### デバッグメニューから設定できるようにする

- 何でもかんでも設定できるようにはしない
- 再ビルド・再インストールが必要になるかどうかがポイント

^ 接続先のサーバーはBuildConfigに入れると変更するたびにビルドが必要になってしまう。
^ 選択出来るようにしておくとスムーズ

---

## 検証速度の改善

### 画面までの操作

- 奥に行くほど時間がかかる

### デバッグメニューから直接飛べるようにしておく

---

## 検証速度の改善

### 動作検証

パラメータの調整はランタイムで出来るようにする
- アニメーション
- ジェスチャー
- 感覚フィードバック

### 何でもかんでも調整可能にしない

- 微調整が必要なものかどうか

^ Find Myでは、AutoTestなどがありました。
^ かっこいいので何でもかんでもやりがちだけど、それは自己満足
^ チームにヒアリングして、どんなものが必要なのかの勘所を鍛えるのもおすすめ

---

## 検証速度の改善

### デバッグ機能の策定

時々デバッグメニューが見つかる事があるので、どんな機能があるか見ておく

- Find My
- UIDebuggingInformationOverlay

![right fit](FindMy.png)


^ ゲームやアプリのデバッグモードは時々誤って流出する事があるので、ネットのニュースをウォッチしてどんな機能があるのか見ておくといいですん

---

## 検証速度の改善 Recap

- デバッグメニューを活用して、アプリの中で完結させる
- 操作を省いたり、自動化する処理を入れておく

---

## 精度

人間が触る以上、ヒューマンエラーや感覚の違いが起こりうる

- 多いのは見過ごし
  - レイアウト・アニメーションのグリッチ
- 定性的な感覚
  - 重い・遅い
- 操作のブレ

---

## 精度

### 見過ごしや感覚的なもの

ログを見ても分からないことが多い
RPScreenRecorderを使うことで操作の15秒前までを記録することができる

```swift
RPScreenRecorder.shared().startClipBuffering()
RPScreenRecorder.shared().exportClip(to: url, duration: 5)
RPScreenRecorder.shared().stopClipBuffering()
```

^ 違和感があったら、すぐに送ってもらう。exportしたビデオクリップをSlackやgithub issueに投稿するところまでアプリ内で完結するといいね
^ 動画を見れば、何を持ってそう思ったのか振り返れる

---

## 精度

### 操作のブレ

- 5秒ごとにコメント送信を10分繰り返す
- 端末を15度づつ傾ける

操作の自動化をする

---

## 精度Recap

- TODO

---

## 関心を上げる

チームサイズが大きくなるほど、個々の関心は自分の作業に向きがち
詳細な分析をせずとも品質指標をアプリ上で見えるようにする
- fps
- 熱
- URLセッション数

画面を占有しないように注意

---

## 関心を上げる Recap

- TODO

---

# デバッグメニューを導入するには

---

# デバッグメニューを導入するには

- 自分で書く
- Settings.bundle
- ライブラリを導入する

---

# 自分で書く

## メリット

サービスに最適化したデバッグメニューが作れる

## デメリット

なるべくサービスの体験にフォーカスした方が良い

^ これは持論ですが

---

# Settings.bundle

## メリット

簡単に作れる
設定変更時に自動でアプリが再起動する

## デメリット

自由度が少ない

---

# ライブラリを導入する

## メリット

簡単に作れる

## デメリット

アプリと別のレイヤーで動作する

---

# noppefoxwolf/DebugMenu

- vear、Pococha、NAHの全てで採用しています
- 過去にvineは画面上にデバッグメニューを表示できる機能を入れていた
- アプリ全体で常に利用できるのが特徴

---

# DEMO

---

# デバッグメニューのコツ

- 担当者・機能ごとにまとめる
- 本番ビルドに含めない
- 要らない機能を入れない

---

- Recap（要点の繰り返し）
    - アプリ開発において、ランタイムデバッグの存在は開発効率を向上させることに貢献する
    - デバッグ機能もチームメンバーに対する製品の開発。ヒアリングを含め気を抜かずにやる
    - 基本はUnitTest
- サマリ（つまり）
    - 内向きの機能開発もエンジニアの仕事の一部

---

# More Information

- ターゲット分けについて
- as

---


# Thanks

---

# ざっくり流れ2

- 自己紹介

    noppe

    キツネが好き

    iOSDC4年連続登壇

    子供が生まれました

    vear、Pococha、NAH

- はじめに
    - 対象
        - アプリを開発しているデベロッパやチーム
        - 難しいところはないです
- アプリ開発のステップを振り返ってみましょう
    1. コンパイル
    2. シミュレータorデバイス実行
    3. UnitTest
    4. 結合テスト
    5. CI
    6. QA
    7. ベータテスト
    8. リリーステスト
    9. 本番テスト
    - 2,6,7,8,9と多くの場面で、実機を使ってテストをしています。
    - 特に6以降はエンジニア以外も触る
- このセッションでは実機動作検証のことをランタイムデバッグと言うことにします
- ランライムデバッグは次のような特徴があります
    - 物理的な台数制約が伴う
    - 人的・時間的コストが伴う
    - 導入が容易
- これらは、全開発工程の40%程度を占めている
    - 工夫することで開発効率を大きく上げることができる
    - 利用しているメンバーに直接聞くのが大事
    - 今日は普段の開発で得たことを共有する
- 次の３つの視点からランタイムデバッグを考える
    - 速度を上げる
        - もっとも時間がかかるのはビルドや転送
            - 頻繁に変更しうるものは、ランタイムで設定を変更できるようにする
                - 接続先のサーバー
        - 手動の操作も時間がかかる
            - 画面遷移のショートカットを用意する
                - 画面遷移がしっかり実装されているのであれば、URLを叩くようにする
                - そうでないなら、直接呼び出しても良い
                - 実機上で自動操作（できる？）
        - 再インストールを伴うものも時間がかかる
            - 機能のショートカットを用意する
                - キャッシュの削除
                - 通信トークンの直指定機能
        - Try&Errorが必要なもの
            - アニメーションの微調整
                - パラメータを画面上で調節できるようにしておく
                - 最近はPlaygroundやSwiftUIで作ることも多い
                - リモート先にいるデザイナーに調整してもらうときに使えるので覚えておくといいよ
        - コミュニケーションも時間がかかる
            - 
    - 精度を上げる
        - 精度の低い情報とは何か
            - 記憶
                - アニメーショングリッチ
            - 感覚
                - 重い・遅い
            - 遠慮
                - ちょっとしたエラー
            - エッジケース
        - これらはデバッガーに繋がない6以降で起きやすい
        - 記憶や感覚の問題はログだけから判別することが難しい
            - startClipBufferingを使うことで解決できる
        - 通報のハードルを下げる
            - 自動通報
            - エラーレポートをデバイス上で行う
        - サンプル数を増やすという考え方は大事
            - 例えばエラーが発生したらSlackに通知する
                - adhocを使っているチームメンバーを全員デバッガーにできる
        - 記憶よりも事実に基づく情報が必要
            - クラッシュレポートの送信
                - 裏で送るだけではなく、直近の操作をレポートさせる
            - 不可視情報の取得
                - 通信速度
        - 手作業では時間やセンサーは制御できない
            - デベロッパメニュー
        - 通信の内容を把握する
    - 関心を上げる
        - チームの関心を惹く
        - チームサイズが大きくなるほど、個々人のタスクに注目しがち
            - 例えば、キリキリにチューニングしているチームと新機能を開発しているチームがある
            - お互いの作業がバッティングする
                - CPU・GPUの負荷などを常に画面上に見えるようにしておく
                - 指標も見えるようにしておく
                - 他のチームも、指標を意識して開発するようになる
        - アプリから担当者を呼べるようにする
        - SceneKitのdebugmenu
- 簡単に導入するにはいくつか方法がある
    - Settings Bundle
        - 設定を変更するとアプリがキルされるのが特徴
    - オーバーレイ
        - 画面内で出来ることが明確なのが特徴
    - noppefoxwolf/DebugMenu
        - vear、Pococha、NAHの全てで採用しています
        - 過去にvineは画面上にデバッグメニューを表示できる機能を入れていた
        - アプリ全体で常に利用できるのが特徴
    - DEMO
    - 起動をアプリから制御する
        - Shortcut
    - 本番に入れないために
        - d_dateの配信見て
        - #if DEBUG
    - チームで使うコツ
        - 誰にでも機能が分かるようにする
    - バッドノウハウ
        - CPU本当に見る必要あるのか考えよう
            - 色々入れるとそれだけで重い
        - 整理をしよう
        - UITestで出来ることをしなくても良い
- Recap（要点の繰り返し）
    - アプリ開発において、ランタイムデバッグの存在は開発効率を向上させることに貢献する
    - デバッグ機能もチームメンバーに対する製品の開発。ヒアリングを含め気を抜かずにやる
- サマリ（つまり）
    - 内向きの機能開発もエンジニアの仕事の一部
- More Information

- Thanks

---

- Archive

    # ざっくり流れ

    構成はこの辺を参考に

    [707_advances_in_app_background_execution.pdf](%E3%83%A9%E3%83%B3%E3%82%BF%E3%82%A4%E3%83%A0%E3%83%86%E3%82%99%E3%83%8F%E3%82%99%E3%83%83%E3%82%AF%E3%82%99%E3%81%AE%E3%82%B9%E3%82%B9%E3%83%A1%20170d4da3e76946a281f97f2c3bc21982/707_advances_in_app_background_execution.pdf)

    アプリのほとんどのコードは実際にユーザーが操作する機能を実装したものです。

    開発環境に限定した特殊なコードの有用性について解説します。

    - ランタイムデバッグoverview
    - ベストプラクティス
    - noppefoxwolf/DebugMenu

    アプリの開発プロセスを見ていきましょう。

    1. 仕様定義
    2. プログラミング
    3. 実機動作確認
        1. 微調整
    4. テスト
    5. QA (1~3の繰り返し)
    6. リリース

    実機で動かすのは1,3この部分でのデバッグをランタイムデバッグとしましょう。

    ここではこんなことをしたりします。

    - 該当の画面までの遷移
    - アプリの再インストール
    - 動作速度の計測
    - アニメーションの確認

    しかし、実機検証は次のような問題を孕んでいます。

    - 人間が作業をするので、時間やコストがかかる
    - 開発中は問題が発生しやすい
    - 必ずしもデバッガーと接続されているわけではない
    - にも関わらず品質の良し悪しを左右する重要なステップである
    - 検証している本人だけが興味を持ってい

    人間が作業するコストは非常に大きいです。

    また、検証の精度はUITestなどを全てにおいて事細かに整備するコストと比べると短期的にパフォーマンスが良い場合も多く、多くの開発現場では本来UITestで検証すべき箇所も

    さらに、人間はミスをします。

    テスト項目が

    つまり、ランタイムデバッグは完璧ではなくこのフェーズに品質の良し悪しを依存するのは良くないと言えます。

    そこで私が勧めるのが、ランタイムで動作するデバッグメニューの存在です。

    デバッグメニューはランタイムデバッグに使う時間を短くし、操作ミスや

    これらは精度が高い代わりに、前提の定義や技術性が必要になる

    ランタイムデバッグはこれらの問題に対して最適な答えと言えます。

    通常、通信に問題がある場合はユーザーに対して柔らかなメッセージを表示します。

    しかし、このメッセージでは厳密に何が発生しているかわかりません。

    このログを追うために、QAチームとエンジニアは連携して問題の解決にあたります。

    QAチームは自分のユーザーIDやユーザー名をエンジニアに伝え、そのIDを元にサーバーに送られたログを遡ります。発生した時間や、状況をSlackやzoomで共有します。

    問題が解決したのは30分後でした。

    これだけ時間がかかっているのは、動的なコミュニケーションが必要とされている点にあります。

    ランタイムデバッグとは、実行されているデバイス上でなるべく問題の本質に辿り着く事が1つの目標であります。

    例えば、今回のケースであれば通信エラーが発生した時に（ちょっと例が弱いな）

    ## ベストプラクティス

    このような情報をテストユーザーが知るためには、UIが必要です。

    ランタイムデバッグ用のUIを設計する上で、いくつか注意するべき点があります。

    1. アプリ全体の挙動を見るものなのか、単一の画面の挙動を見るものなのか
    2. 

    # 自己紹介

    おはようございます

    noppeです

    # ランタイムデバッグとは

    ## ランタイムデバッグとは

    ゲームのデバッグメニューを想像して欲しい

    デバッグメニューはユーザー権限を超えた権限の操作や、参照が行えるメニューのこと

    ランタイム(アプリの実行中)に、デバッグ(不具合の特定)を行うものはランタイムデバッグと言える。

    今日はデバッグメニューを中心にランタイムデバッグについてお話しします

    ## デバッグメニューのメリット

    主に詳細な情報収集と時間短縮の側面がある。

    アプリはユーザーに最適な体験をさせるために、持っている情報を絞って表示する性質がある。

    例えば接続されているネットワークは、ユーザーには4Gで繋がっている程度の情報しか渡されない。

    しかし、問題が発生した時に必要な情報は速度や強度、1分間の切断回数などより詳細なものになる。

    QAやドッグフーディン中など、常にXcodeが接続されていない環境では、これらの情報を集めるのは難しい事もある。

    デバッグメニューはそういった環境で、詳細な情報を収集することに役立つ。

    これはログの置き換えが出来るという意味ではない事に注意。ログはログで取るべきだがログはエッジケースに対する小回りが効かない。

    デバッグメニューはどちらかというと、決まりきった課題に対して用意するもの。

    時間短縮の側面では、再インストールやログイン・ログアウトなどの時間のかかる作業のショートカットを用意する意味合いが強い。

    問題が発生する画面までの遷移を短縮したり、同じ画面の中で課金ユーザーと非課金ユーザーのフラグを切り替えたりする。

    もっと大きな視点では、ビルド時間を省略するために接続先のサーバーを切り替える事にも使われる。

    # デバッグメニューを導入する

    デバッグメニューを導入するにあたって、考慮しておく事がある。

    デバッグメニューはあくまで開発における効率を上げるためのもので、直接ユーザーの利益になるわけではないという事だ。

    デバッグメニューの開発時間はなるべく短くして、その時間をユーザーの体験向上に当たるべき。

    # DebugMenuを利用して、開発を効率化する

    # 導入事例の紹介

    - Pococha
    - NotAHotel

    - ランタイムデバッグとは
        - ランタイムとはアプリの起動中を指します
        - デバッグはとても広義
            - 今回は不具合を見つけること全般を指します
        - 多くのシーンで使われている
            - ゲームのデバッグメニュー
            - 「探す」の隠し画面とか
            - androidのfps見るやつとか
            - vineとか
            - 会社で聞いたら全てのアプリで実装がありました。

    - ランタイムデバッガーのない世界
        - Xcodeと繋いでデバッグするしか出来ない
    - あると何が良いか
    - 隠しメニューってなんだかカッコいいですよね。開発のテンションが上がります。
    - QA作業の効率化
    - TCAのState
    - ランタイムデバッグはチームとエンジニアを繋ぐ
        - パフォーマンスや品質の意識を変える
        - 操作の効率化から、実際のアプリの改善案が生まれるかもしれない
        - 簡易的に画面を呼び出せる
    - 環境の切り替え
        - 課金ユーザー
        - サーバー
    - チームに導入する意味
    - 本番アプリに入れないようにするには
        - プライベートフレームワークを使う時もある
        - アプリを分ける事がベストプラクティス

    デバッグメニュー
    - ローカルプッシュ通知で画面遷移みる
    - ローカルのログをSlackに送る
    - サーバー選択
    - UserDefaultの設定
    - CoreDataの表示
    - API Historyの表示

    ```
    - チュートリアルなどの1回しか使わないやつ
    - ViewController出したり

    - メニューの出し方
    - 本番で出すのもあり（user idとか）

    - excluded filenamesを設定すると、ビルドに含めないようにできる

    - デバッグメニュー
    ```

    アプリを起動するデバッグ

    - data:textはもう使えない
    - Local通知
        - 微妙に実装が必要
    - Intent これが良い

    開発速度と正確性を上げる

[218_exploring_new_data_representations_in_healthkit.pdf](%E3%83%A9%E3%83%B3%E3%82%BF%E3%82%A4%E3%83%A0%E3%83%86%E3%82%99%E3%83%8F%E3%82%99%E3%83%83%E3%82%AF%E3%82%99%E3%81%AE%E3%82%B9%E3%82%B9%E3%83%A1%20170d4da3e76946a281f97f2c3bc21982/218_exploring_new_data_representations_in_healthkit.pdf)

[https://speakerdeck.com/saraheolson/ui-testing-for-fun-and-profit](https://speakerdeck.com/saraheolson/ui-testing-for-fun-and-profit)